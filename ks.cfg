#version=RHEL10
# System authorization information
auth --enableshadow --passalgo=sha512

# Use text mode install
text

# Run the Setup Agent on first boot
firstboot --disable

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'

# System language
lang en_US.UTF-8

# Network information
network --bootproto=dhcp --device=link --activate

# Root password (change this!)
rootpw --iscrypted $6$rounds=4096$saltsalt$hash.goes.here

# System services
services --enabled="chronyd,auditd,rsyslog"

# System timezone
timezone America/New_York --isUtc

# Bootloader configuration
bootloader --location=mbr --boot-drive=sda --append="audit=1 audit_backlog_limit=8192 crashkernel=auto"

# Clear the Master Boot Record
zerombr

# Partition clearing information
clearpart --all --initlabel

# Disk partitioning information (STIG-compliant layout)
part biosboot --fstype=biosboot --size=1
part /boot --fstype=xfs --size=750
part /boot/efi --fstype=efi --size=750
part pv.01 --fstype="lvmpv" --size=501375
volgroup rhel --pesize=4096 pv.01
logvol / --fstype="xfs" --size=80000 --name=root --vgname=rhel
logvol /home --fstype="xfs" --size=5000 --name=home --vgname=rhel --grow
logvol swap --fstype="swap" --size=8192 --name=swap --vgname=rhel
logvol /tmp --fstype="xfs" --size=15000 --name=tmp --vgname=rhel --fsoptions="nodev,nosuid,noexec"
logvol /var/log --fstype="xfs" --size=15000 --name=var_log --vgname=rhel
logvol /var/log/audit --fstype="xfs" --size=15000 --name=var_log_audit --vgname=rhel
logvol /var --fstype="xfs" --size=15000 --name=var --vgname=rhel
logvol /var/tmp --fstype="xfs" --size=2048 --name=var_tmp --vgname=rhel --fsoptions="nodev,nosuid,noexec"
logvol /opt --fstype="xfs" --size=15000 --name=opt --vgname=rhel

# Bootc container image deployment
ostreecontainer --url=registry://localhost/myboot:latest

# System users (create a non-root user)
user --groups=wheel --name=admin --password=$6$rounds=4096$saltsalt$hash.goes.here --iscrypted --gecos="System Administrator"

# SELinux configuration
selinux --enforcing

# Firewall configuration
firewall --enabled --ssh

# Disable kdump to save memory (optional)
%addon com_redhat_kdump --disable
%end

# Post-installation script
%post --log=/root/ks-post.log

# Update system
dnf update -y

# Configure AIDE database
aide --init
mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz

# Set up automatic AIDE checks
cat << 'EOF' > /etc/cron.daily/aide-check
#!/bin/bash
/usr/sbin/aide --check | /bin/mail -s "AIDE Integrity Check" root
EOF
chmod +x /etc/cron.daily/aide-check

# Configure audit rules for STIG compliance
cat << 'EOF' >> /etc/audit/rules.d/stig.rules
# STIG-required audit rules
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change
-w /etc/group -p wa -k identity
-w /etc/passwd -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity
EOF

# Set proper mount options in fstab for STIG compliance
sed -i 's|\(/tmp.*xfs.*\)defaults|\1defaults,nodev,nosuid,noexec|' /etc/fstab
sed -i 's|\(/var/tmp.*xfs.*\)defaults|\1defaults,nodev,nosuid,noexec|' /etc/fstab

# Configure chronyd for time synchronization
cat << 'EOF' > /etc/chrony.conf
# STIG-compliant NTP configuration
server 0.rhel.pool.ntp.org iburst
server 1.rhel.pool.ntp.org iburst
server 2.rhel.pool.ntp.org iburst
server 3.rhel.pool.ntp.org iburst

driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
EOF

# Enable and start essential services
systemctl enable chronyd
systemctl enable auditd
systemctl enable rsyslog

# Configure SSH for STIG compliance
sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/#MaxAuthTries 6/MaxAuthTries 3/' /etc/ssh/sshd_config
echo "ClientAliveInterval 300" >> /etc/ssh/sshd_config
echo "ClientAliveCountMax 0" >> /etc/ssh/sshd_config

# Set up log rotation
cat << 'EOF' > /etc/logrotate.d/stig-logs
/var/log/messages /var/log/secure /var/log/maillog /var/log/spooler /var/log/boot.log /var/log/cron {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/rsyslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
EOF

# Clean up
dnf clean all

%end

# Reboot after installation
reboot
